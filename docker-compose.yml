version: '2'

services:
  web:
    build: .
    command: bundle exec foreman start -f ./Procfile.dev -p 3000
    entrypoint: ./bin/docker/ruby_entrypoint
    volumes:
      - .:/app
      - rubygems_cache:/rubygems
    ports:
      - '3000:3000'
    environment:
      GEM_HOME: '/rubygems'
      BUNDLE_PATH: '/rubygems'
      DATABASE_URL: 'postgres://postgres:@postgres:5432'
      REDIS_URL: 'redis://redis:6379'
    depends_on:
      - postgres
      - redis
    # needed for Codeship Pro:
    links:
      - postgres
      - redis

  yarn:
    build: .
    command: yarn run webpack --watch
    entrypoint: ./bin/docker/yarn_entrypoint
    volumes:
      - .:/app
      - yarn_cache:/app/node_modules

  postgres:
    image: postgres:9.6
    ports:
      - '5432'
    volumes:
      - postgres_data:/var/lib/postgresql

  redis:
    image: redis:3.2
    ports:
      - '6379'

volumes:
  postgres_data:
  rubygems_cache:
  yarn_cache:
